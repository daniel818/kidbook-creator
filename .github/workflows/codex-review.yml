name: Codex Advanced Code Review
on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  codex_review:
    # Trigger logic: Automated on PR or manual via /review comment
    if: |
      github.event_name == 'pull_request' || 
      (github.event.issue.pull_request && (startsWith(github.event.comment.body, '/review')))
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # AI needs full context to see file history/deletions

      - name: AI Code Review
        uses: AleksandrFurmenkovOfficial/ai-code-review@v1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          ai_provider: "openai"
          openai_model: "gpt-5.2-codex"
          
          # This setting ensures comments are placed directly on the code lines
          review_type: "inline"
          
          # Custom rules for file deletions and professional architecture
          review_rules: |
            1. Role: Senior R&D Architect.
            2. File Deletions: If a file is deleted, search the diff for orphaned imports or references.
            3. Logic: Focus on O(n) complexity and systematic race conditions.
            4. Tone: Professional and technical.
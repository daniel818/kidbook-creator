name: Codex Advanced Code Review
on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  codex_review:
    if: |
      github.event_name == 'pull_request' || 
      (github.event.issue.pull_request && (startsWith(github.event.comment.body, '/review') || startsWith(github.event.comment.body, '/codex')))
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Necessary to compare changes

      - name: Run Codex GPT-5.2 Review
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: "gpt-5.2-codex"
          effort: "high"
          # 'inline' mode tells the action to map comments to specific lines
          output-mode: "inline" 
          prompt: |
            Role: Senior R&D Architect.
            Task: Conduct a professional, systematic code review.
            
            Specific Instructions:
            1. If a file is being deleted, verify if there are any remaining references to it in the codebase to prevent broken imports.
            2. Identify systematic bugs, edge cases, and O(n) performance bottlenecks.
            3. Ensure clean code and maintainability.
            4. If the logic is sound but could be cleaner, provide a 'Refactor' suggestion.

      - name: Post Inline Feedback
        uses: openai/codex-github-reporter@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          results: ${{ steps.run_codex.outputs.results }}